import { uploadImageServer } from './storage'

/**
 * Claude Sonnet 4.5ã‚’ä½¿ç”¨ã—ã¦ç”»åƒç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
 * @param title è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«
 * @param summary è¨˜äº‹ã‚µãƒãƒªãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @param body è¨˜äº‹æœ¬æ–‡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @returns ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼æ™‚ã¯null
 */
async function generateImagePromptWithClaude(
  title: string,
  summary?: string | null,
  body?: string | null
): Promise<string | null> {
  const apiKey = process.env.ANTHROPIC_API_KEY

  if (!apiKey) {
    console.warn('ANTHROPIC_API_KEY is not set, using fallback prompt')
    return null
  }

  try {
    console.log('ğŸ¤– Generating image prompt with Claude Sonnet 4.5...')
    const startTime = Date.now()

    // è¨˜äº‹å†…å®¹ã‚’æº–å‚™ï¼ˆæœ¬æ–‡ã¯æœ€åˆã®1000æ–‡å­—ã®ã¿ä½¿ç”¨ã—ã¦ã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
    const contentPreview = body ? body.substring(0, 1000) : ''

    const userMessage = `è¨˜äº‹æƒ…å ±:
ã‚¿ã‚¤ãƒˆãƒ«: ${title}
ã‚µãƒãƒªãƒ¼: ${summary || 'ãªã—'}
æœ¬æ–‡ï¼ˆå†’é ­ï¼‰: ${contentPreview || 'ãªã—'}

ã“ã®è¨˜äº‹ã«æœ€é©ãªãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã€è©³ç´°ãªè‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 500,
        temperature: 0.7,
        system: `ã‚ãªãŸã¯åŒ»ç™‚ãƒ»ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼åˆ†é‡ã®ãƒ–ãƒ­ã‚°è¨˜äº‹ã«æœ€é©ãªãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã€ç”»åƒç”ŸæˆAIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆã®å°‚é–€å®¶ã§ã™ã€‚

è¨˜äº‹å†…å®¹ã‚’æ·±ãåˆ†æã—ã€ä»¥ä¸‹ã‚’å«ã‚€å…·ä½“çš„ã§è©³ç´°ãªè‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„:

å¿…é ˆè¦ç´ :
- å…·ä½“çš„ãªãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¦ç´ ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã€ã‚·ãƒ³ãƒœãƒ«ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€æ§‹å›³ï¼‰
- ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ ï¼ˆåŒ»ç™‚=é’/ç·‘/ç™½ã€ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼=é’/ç´«/é»’ãªã©ï¼‰
- ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãƒ¢ãƒ€ãƒ³ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã€æŠ½è±¡çš„ã€ã‚¤ãƒ©ã‚¹ãƒˆé¢¨ãªã©ï¼‰
- ãƒ ãƒ¼ãƒ‰ãƒ»é›°å›²æ°—ï¼ˆé©æ–°çš„ã€ä¿¡é ¼ã§ãã‚‹ã€æœªæ¥çš„ãªã©ï¼‰
- æŠ€è¡“çš„è¦ä»¶ï¼ˆ21:9ã®æ¨ªé•·ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã€ç”»åƒå†…ã«ãƒ†ã‚­ã‚¹ãƒˆãªã—ï¼‰

é‡è¦ãªåˆ¶ç´„:
- å†™çœŸçš„ã§ã¯ãªãã€æŠ½è±¡çš„ã¾ãŸã¯ã‚¤ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çš„ãªã‚¹ã‚¿ã‚¤ãƒ«
- æ—¥æœ¬ã®åŒ»ç™‚ãƒ»ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼æ–‡è„ˆã‚’ç†è§£ã—ãŸä¸Šã§ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«é€šç”¨ã™ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³
- ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§æ¸…æ½”æ„Ÿã®ã‚ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³

å‡ºåŠ›å½¢å¼:
- è‹±èªã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã¿ã‚’å‡ºåŠ›ï¼ˆèª¬æ˜ã‚„å‰ç½®ãã¯ä¸è¦ï¼‰
- 1ã¤ã®æ®µè½ã¨ã—ã¦ç°¡æ½”ã«è¨˜è¿°`,
        messages: [
          {
            role: 'user',
            content: userMessage,
          },
        ],
      }),
    })

    if (!response.ok) {
      const errorText = await response.text()
      console.error('Claude API error:', errorText)
      return null
    }

    const data = await response.json()
    const generatedPrompt = data.content?.[0]?.text

    if (!generatedPrompt) {
      console.error('No prompt generated by Claude')
      return null
    }

    const elapsed = Date.now() - startTime
    console.log(`âœ… Claude prompt generated in ${elapsed}ms`)
    console.log(`ğŸ“ Generated prompt: ${generatedPrompt.substring(0, 200)}...`)

    return generatedPrompt
  } catch (error) {
    console.error('Claude prompt generation failed:', error)
    return null
  }
}

/**
 * Gemini 2.5 Flash Image APIã‚’ä½¿ç”¨ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒã‚’ç”Ÿæˆï¼ˆ2æ®µéšãƒ•ãƒ­ãƒ¼ï¼‰
 * @param title è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«
 * @param summary è¨˜äº‹ã‚µãƒãƒªãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @param body è¨˜äº‹æœ¬æ–‡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @returns ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®å…¬é–‹URLã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼æ™‚ã¯null
 */
export async function generateHeaderImage(
  title: string,
  summary?: string | null,
  body?: string | null
): Promise<string | null> {
  const geminiApiKey = process.env.GOOGLE_AI_API_KEY

  if (!geminiApiKey) {
    console.error('GOOGLE_AI_API_KEY is not set')
    return null
  }

  try {
    console.log('ğŸ¨ Starting 2-stage image generation...')
    const totalStartTime = Date.now()

    // Stage 1: Claude ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
    let imagePrompt = await generateImagePromptWithClaude(title, summary, body)

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Claude ãŒå¤±æ•—ã—ãŸå ´åˆã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨
    if (!imagePrompt) {
      console.warn('âš ï¸ Claude prompt generation failed, using fallback template')
      imagePrompt = createFallbackPrompt(title, summary)
    }

    // Stage 2: Gemini ã§ç”»åƒç”Ÿæˆ
    console.log('ğŸ–¼ï¸ Generating image with Gemini 2.5 Flash Image...')
    const geminiStartTime = Date.now()

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${geminiApiKey}`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [
            {
              parts: [
                {
                  text: imagePrompt,
                },
              ],
            },
          ],
          generationConfig: {
            temperature: 1,
            topK: 40,
            topP: 0.95,
            maxOutputTokens: 8192,
            imageConfig: {
              aspectRatio: "21:9"
            }
          },
        }),
      }
    )

    if (!response.ok) {
      const errorText = await response.text()
      console.error('âŒ Gemini API error (HTTP', response.status, '):', errorText)
      return null
    }

    const data = await response.json()

    // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆbase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ï¼‰
    // Gemini may return text + image, so search through all parts
    const parts = data.candidates?.[0]?.content?.parts || []
    const imageData = parts.find((part: any) => part.inlineData)?.inlineData

    if (!imageData || !imageData.data) {
      console.error('âŒ No image data in Gemini response')
      console.error('Response structure:', JSON.stringify(data, null, 2))
      return null
    }

    const geminiElapsed = Date.now() - geminiStartTime
    console.log(`âœ… Gemini image generated in ${geminiElapsed}ms`)

    // Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦Bufferã«å¤‰æ›
    const imageBuffer = Buffer.from(imageData.data, 'base64')

    // Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    console.log('â˜ï¸ Uploading to Supabase Storage...')
    const fileName = `generated-${Date.now()}.jpg`
    const publicUrl = await uploadImageServer(
      imageBuffer,
      fileName,
      'image/jpeg',
      'post-images'
    )

    const totalElapsed = Date.now() - totalStartTime
    console.log(`ğŸ‰ Image generation completed in ${totalElapsed}ms`)
    console.log(`ğŸ”— Image URL: ${publicUrl}`)

    return publicUrl
  } catch (error) {
    console.error('Image generation failed:', error)
    return null
  }
}

/**
 * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
 * Claude ãŒå¤±æ•—ã—ãŸå ´åˆã«ä½¿ç”¨
 */
function createFallbackPrompt(title: string, summary?: string | null): string {
  return `Create a professional, modern header image for a blog post about: "${title}".
${summary ? `Context: ${summary}` : ''}

Style requirements:
- Professional and clean design
- Modern tech/medical theme
- High quality, visually appealing
- 21:9 ultra-wide aspect ratio (approximately 2.33:1) - very important!
- Horizontal composition optimized for wide screens
- Abstract or illustrative style
- No text in the image

The image should convey innovation, technology, and professionalism in a wide panoramic format.`
}
