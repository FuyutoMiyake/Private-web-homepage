// Medical News Blog - Prisma Schema
// learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===== Core Models =====

model Post {
  id       String   @id @default(uuid())
  slug     String   @unique
  title    String
  body     String   // MDX/Markdown
  summary  String?
  category String   @default("other") // 'policy' | 'dx' | 'other'
  tags     String[]

  headerImageUrl String?  // Header/featured image URL

  publishAt DateTime?
  status    String   @default("draft") // 'draft' | 'scheduled' | 'published'

  // Paywall
  paywallEnabled       Boolean  @default(true)
  freeMode             String   @default("marker") // 'marker' | 'chars' | 'sections'
  freeChars            Int?
  freeSections         Int?
  priceJpy             Int?
  isSubscriptionExempt Boolean  @default(false)

  // Featured
  isFeatured    Boolean   @default(false)
  featuredOrder Int?
  featuredUntil DateTime?

  // Search (PostgreSQLで自動生成)
  searchVector Unsupported("tsvector")?

  sourceUrls String[] // 一次情報URL (最大3つ)

  createdBy String? // User.id (将来)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  comments Comment[]

  @@index([status, publishAt])
  @@index([isFeatured, featuredOrder])
  @@index([category])
  @@index([tags])
  // @@index([searchVector], type: Gin)  // Disabled for now, will add manually after pg_trgm installation
  // @@index([title(ops: raw("gin_trgm_ops"))], type: Gin)  // Requires pg_trgm extension
}

model ArticleAlias {
  id        String   @id @default(uuid())
  postId    String
  oldSlug   String   @unique
  createdAt DateTime @default(now())

  @@index([oldSlug])
}

model Comment {
  id          String   @id @default(uuid())
  postId      String
  authorName  String?
  authorEmail String?
  body        String
  status      String   @default("pending") // 'pending' | 'approved' | 'rejected'
  ipHash      String?
  createdAt   DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, status])
  @@index([status, createdAt])
}

// ===== Newsletter =====

model NewsletterSubscriber {
  id         String   @id @default(uuid())
  email      String   @unique
  status     String   @default("active") // 'active' | 'unsubscribed'
  categories String[] // ['policy', 'dx'] など、購読カテゴリ
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([email])
  @@index([status])
}

// ===== Future Models =====

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  role      String   @default("viewer") // 'admin' | 'editor' | 'viewer'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Video {
  id              String   @id @default(uuid())
  provider        String   @default("drive") // 'drive' | 'stream' | 'mux'
  providerAssetId String?  @unique
  title           String?
  isPublicPreview Boolean  @default(false)
  createdAt       DateTime @default(now())
}

model Plan {
  id            String @id @default(uuid())
  type          String // 'subscription' | 'one_time'
  stripePriceId String?
}

model Entitlement {
  id               String    @id @default(uuid())
  userId           String
  kind             String    // 'ppv' | 'sub'
  postId           String?   // PPVの時のみ
  source           String    // 'stripe' | 'manual'
  status           String    @default("active") // 'active' | 'cancelled' | 'past_due'
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  stripeSubscriptionId String? @unique
  createdAt        DateTime  @default(now())

  @@index([userId, kind, postId])
  @@index([stripeSubscriptionId])
}

model SiteSettings {
  id Int @id @default(1)

  siteTitle String @default("Fuyuto Web")

  // Comment settings
  commentMode String @default("pre_moderation") // 'pre_moderation' | 'post_moderation'

  // Payment settings
  currency        String  @default("JPY")
  taxInclusive    Boolean @default(true)
  defaultPriceJpy Int?
  paywallDefaultMode String @default("marker")

  // Featured posts
  featuredMax Int @default(4)

  // Image generation
  autoGenerateImages Boolean @default(false)

  // SNS Links
  snsTwitter   String @default("")
  snsLinkedin  String @default("")
  snsLine      String @default("")
  snsInstagram String @default("")
  snsYoutube   String @default("")
  snsTiktok    String @default("")
  snsFacebook  String @default("")

  updatedAt DateTime @updatedAt
}

// ===== API Keys =====

model ApiKey {
  id          String    @id @default(uuid())
  name        String
  key         String    @unique
  isActive    Boolean   @default(true)
  createdBy   String?   // User identifier for tracking who created this API key
  createdAt   DateTime  @default(now())
  lastUsedAt  DateTime?
  usageCount  Int       @default(0)

  @@index([key])
  @@index([isActive])
}

// ===== Payment & Idempotency =====

model Payment {
  id        String   @id @default(uuid())
  provider  String   // 'stripe'
  extId     String?  @unique
  amountJpy Int?
  currency  String?  // 'jpy'
  status    String   // 'created' | 'succeeded' | 'failed' | 'refunded'
  meta      Json?
  userId    String?
  postId    String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([status])
}

model IdempotencyKey {
  key       String   @id
  createdAt DateTime @default(now())

  @@index([createdAt])
}

// ===== Email Events =====

model EmailEvent {
  id        String   @id @default(uuid())
  type      String   // 'requested' | 'delivered' | 'opened' | 'clicked' | 'bounced' | 'complained'
  toMasked  String
  messageId String?  @unique
  dryRun    Boolean  @default(true)
  meta      Json?
  createdAt DateTime @default(now())

  @@index([type, createdAt])
  @@index([messageId])
}
